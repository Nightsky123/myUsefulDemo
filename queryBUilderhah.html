<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div id="builder-widgets"></div>
<div id="btn-reset" style='width:100px;height:20px;background:yellow;'></div>
<div id="btn-set" style='width:100px;height:20px;background:green;'></div>
<div id="btn-get" style='width:100px;height:20px;background:red;'></div>
<script src="js/jquery-2.1.1.min.js"></script>
<!--<script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>-->

<!--<script src="http://querybuilder.js.org/assets/js/docs.min.js"></script>-->
<script src="qqq.js"></script>

<script src="js/main.js"></script>
<script src="js/defaults.js"></script>
<script src="js/jquery.js"></script>
<script src="js/utils.js"></script>
<script src="js/model.js"></script>
<script src="js/query-builder.standalone.min.js"></script>
<script src="js/plugins.js"></script>

<!--<script src="bootstrap-select.js"></script>-->
<!--<script src="plugins/sortable/plugin.js"></script>-->
<!--<script src="plugins/filter-description/plugin.js"></script>-->
<!--<script src="plugins/change-filters/plugin.js"></script>-->
<!--<script src="plugins/bt-checkbox/plugin.js"></script>-->
<!--<script src="plugins/bt-selectpicker/plugin.js"></script>-->
<!--<script src="plugins/bt-tooltip-errors/plugin.js"></script>-->
<!--<script src="plugins/not-group/plugin.js"></script>-->
<!--<script src="plugins/invert/plugin.js"></script>-->
<script src="plugins/unique-filter/plugin.js"></script>
<script>
    var rules_widgets = {
        condition: 'OR',
        rules: [{
            id: 'date',
            operator: 'equal',
            value: '1991/11/17'
        }, {
            id: 'rate',
            operator: 'equal',
            value: 22
        }, {
            id: 'category',
            operator: 'equal',
            value: '38'
        }, {
            condition: 'AND',
            rules: [{
                id: 'coord',
                operator: 'equal',
                value: 'B.3'
            }]
        }]
    };

    // Fix for Selectize
    $('#builder-widgets').on('afterCreateRuleInput.queryBuilder', function(e, rule) {
        if (rule.filter.plugin == 'selectize') {
            rule.$el.find('.rule-value-container').css('min-width', '200px')
                .find('.selectize-control').removeClass('form-control');
        }
    });

    $('#builder-widgets').queryBuilder({
        // plugins: ['bt-tooltip-errors'],

        filters: [{
            id: 'date',
            label: 'Datepicker',
            type: 'date',
            validation: {
                format: 'YYYY/MM/DD'
            },
            plugin: 'datepicker',
            plugin_config: {
                format: 'yyyy/mm/dd',
                todayBtn: 'linked',
                todayHighlight: true,
                autoclose: true
            }
        }, {
            id: 'rate',
            label: 'Slider',
            type: 'integer',
            validation: {
                min: 0,
                max: 100
            },
            plugin: 'slider',
            plugin_config: {
                min: 0,
                max: 100,
                value: 0
            },
            valueSetter: function(rule, value) {
                if (rule.operator.nb_inputs == 1) value = [value];
                rule.$el.find('.rule-value-container input').each(function(i) {
                    $(this).slider('setValue', value[i] || 0);
                });
            },
            valueGetter: function(rule) {
                var value = [];
                rule.$el.find('.rule-value-container input').each(function() {
                    value.push($(this).slider('getValue'));
                });
                return rule.operator.nb_inputs == 1 ? value[0] : value;
            }
        }, {
            id: 'category',
            label: 'Selectize',
            type: 'string',
            plugin: 'selectize',
            plugin_config: {
                valueField: 'id',
                labelField: 'name',
                searchField: 'name',
                sortField: 'name',
                create: true,
                maxItems: 1,
                plugins: ['remove_button'],
                onInitialize: function() {
                    var that = this;

                    if (localStorage.demoData === undefined) {
                        $.getJSON(baseurl + '/assets/demo-data.json', function(data) {
                            localStorage.demoData = JSON.stringify(data);
                            data.forEach(function(item) {
                                that.addOption(item);
                            });
                        });
                    }
                    else {
                        JSON.parse(localStorage.demoData).forEach(function(item) {
                            that.addOption(item);
                        });
                    }
                }
            },
            valueSetter: function(rule, value) {
                rule.$el.find('.rule-value-container input')[0].selectize.setValue(value);
            }
        }, {
            id: 'coord',
            label: 'Coordinates',
            type: 'string',
            validation: {
                format: /^[A-C]{1}.[1-6]{1}$/
            },
            input: function(rule, name) {
                var $container = rule.$el.find('.rule-value-container');

                $container.on('change', '[name='+ name +'_1]', function(){
                    var h = '';

                    switch ($(this).val()) {
                        case 'A':
                            h = '<option value="-1">-</option> <option value="1">1</option> <option value="2">2</option>';
                            break;
                        case 'B':
                            h = '<option value="-1">-</option> <option value="3">3</option> <option value="4">4</option>';
                            break;
                        case 'C':
                            h = '<option value="-1">-</option> <option value="5">5</option> <option value="6">6</option>';
                            break;
                    }

                    $container.find('[name$=_2]')
                        .html(h).toggle(!!h)
                        .val('-1').trigger('change');
                });

                return '\
      <select name="'+ name +'_1"> \
        <option value="-1">-</option> \
        <option value="A">A</option> \
        <option value="B">B</option> \
        <option value="C">C</option> \
      </select> \
      <select name="'+ name +'_2" style="display:none;"></select>';
            },
            valueGetter: function(rule) {
                return rule.$el.find('.rule-value-container [name$=_1]').val()
                    +'.'+ rule.$el.find('.rule-value-container [name$=_2]').val();
            },
            valueSetter: function(rule, value) {
                if (rule.operator.nb_inputs > 0) {
                    var val = value.split('.');

                    rule.$el.find('.rule-value-container [name$=_1]').val(val[0]).trigger('change');
                    rule.$el.find('.rule-value-container [name$=_2]').val(val[1]).trigger('change');
                }
            }
        }],

        rules: rules_widgets
    });

    $('#btn-reset').on('click', function() {
        $('#builder-widgets').queryBuilder('reset');
    });

    $('#btn-set').on('click', function() {
        $('#builder-widgets').queryBuilder('setRules', rules_widgets);
    });

    $('#btn-get').on('click', function() {
        debugger;
        var result = $('#builder-widgets').queryBuilder('getRules');
debugger;
        if (!$.isEmptyObject(result)) {
            console.log(JSON.stringify(result, null, 2));
        }
    });


</script>
</body>
</html>